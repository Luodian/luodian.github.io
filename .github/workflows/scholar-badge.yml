name: Update Badges
on:
  schedule:
    - cron: '0 0 * * 0'  # Every Sunday at midnight UTC
  workflow_dispatch:  # Manual trigger

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install gsbg requests

      - name: Generate citation badge
        run: |
          python -c "
          import gsbg
          gsbg.gene_citation_badge_svg(
            link='https://scholar.google.com/citations?user=1_zc1-IAAAAJ',
            link_type='profile',
            svg_name='citations.svg',
            path_to_save='assets/img'
          )
          "

      - name: Generate GitHub stars badge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python << 'EOF'
          import requests
          import os

          def get_user_stars(username):
              stars = 0
              page = 1
              while True:
                  r = requests.get(f'https://api.github.com/users/{username}/repos?per_page=100&page={page}')
                  repos = r.json()
                  if not repos:
                      break
                  stars += sum(repo.get('stargazers_count', 0) for repo in repos)
                  page += 1
              return stars

          def get_org_stars(org):
              stars = 0
              page = 1
              while True:
                  r = requests.get(f'https://api.github.com/orgs/{org}/repos?per_page=100&page={page}')
                  repos = r.json()
                  if not repos or isinstance(repos, dict):
                      break
                  stars += sum(repo.get('stargazers_count', 0) for repo in repos)
                  page += 1
              return stars

          personal = get_user_stars('luodian')
          org = get_org_stars('EvolvingLMMs-Lab')
          total = personal + org

          svg = f'''<svg xmlns="http://www.w3.org/2000/svg" width="140" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <mask id="a"><rect width="140" height="20" rx="3" fill="#fff"/></mask>
            <g mask="url(#a)">
              <path fill="#555" d="M0 0h80v20H0z"/>
              <path fill="#4c1" d="M80 0h60v20H80z"/>
              <path fill="url(#b)" d="M0 0h140v20H0z"/>
            </g>
            <g fill="#fff" text-anchor="middle" font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="40" y="15" fill="#010101" fill-opacity=".3">GitHub Stars</text>
              <text x="40" y="14">GitHub Stars</text>
              <text x="110" y="15" fill="#010101" fill-opacity=".3">{total:,}</text>
              <text x="110" y="14">{total:,}</text>
            </g>
          </svg>'''

          os.makedirs('assets/img', exist_ok=True)
          with open('assets/img/github-stars.svg', 'w') as f:
              f.write(svg)
          print(f'Total stars: {total} (personal: {personal}, org: {org})')
          EOF

      - name: Commit and push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: update badges"
          file_pattern: "assets/img/*.svg"
